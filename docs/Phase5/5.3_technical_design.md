# Phase 5.3: Technical Design - Mental Health Platform UI/UX Refactor

## Executive Summary

This technical design document provides comprehensive specifications for implementing the mental health platform's UI/UX refactor. The design focuses on accessibility-first development, mobile optimization, and scalable component architecture within the existing Next.js/TypeScript/Tailwind stack.

## System Architecture

### Technology Stack
- **Framework**: Next.js 15 with App Router
- **Language**: TypeScript 5.x
- **Styling**: Tailwind CSS with CSS custom properties
- **UI Components**: Radix UI primitives with custom implementations
- **State Management**: React hooks with context providers
- **Form Handling**: React Hook Form with validation
- **Testing**: Jest, React Testing Library, Playwright

### Design System Architecture

#### CSS Custom Properties Structure
```css
/* src/styles/design-tokens.css */
:root {
  /* Color System */
  --color-primary-50: #eff6ff;
  --color-primary-500: #3b82f6;
  --color-primary-600: #2563eb;

  /* Typography Scale */
  --text-xs: clamp(0.75rem, 0.7rem + 0.2vw, 0.875rem);
  --text-sm: clamp(0.875rem, 0.8rem + 0.3vw, 1rem);
  --text-base: clamp(1rem, 0.9rem + 0.4vw, 1.125rem);

  /* Spacing System */
  --space-1: 0.25rem;   /* 4px */
  --space-2: 0.5rem;    /* 8px */
  --space-4: 1rem;      /* 16px */
  --space-6: 1.5rem;    /* 24px */

  /* Component Tokens */
  --button-height: 2.5rem;        /* 40px - touch friendly */
  --input-height: 2.5rem;         /* 40px - touch friendly */
  --focus-ring-width: 2px;
  --focus-ring-color: var(--color-primary-500);
}
```

#### Tailwind Configuration
```javascript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      colors: {
        primary: {
          50: 'var(--color-primary-50)',
          500: 'var(--color-primary-500)',
          600: 'var(--color-primary-600)',
        }
      },
      fontSize: {
        'xs': 'var(--text-xs)',
        'sm': 'var(--text-sm)',
        'base': 'var(--text-base)',
      },
      spacing: {
        '1': 'var(--space-1)',
        '2': 'var(--space-2)',
        '4': 'var(--space-4)',
      }
    }
  }
}
```

## Component Architecture

### Core Component Patterns

#### Button Component
```typescript
// src/components/ui/button.tsx
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
  loading?: boolean;
  fullWidth?: boolean;
}

export function Button({
  variant = 'primary',
  size = 'md',
  loading = false,
  fullWidth = false,
  className,
  children,
  disabled,
  ...props
}: ButtonProps) {
  return (
    <button
      className={cn(
        // Base styles
        'inline-flex items-center justify-center',
        'font-medium transition-colors duration-200',
        'focus:outline-none focus:ring-2 focus:ring-offset-2',
        'disabled:opacity-50 disabled:pointer-events-none',

        // Size variants (touch-friendly minimums)
        {
          'h-10 px-3 text-sm min-h-[44px]': size === 'sm',
          'h-11 px-4 text-base min-h-[44px]': size === 'md',
          'h-12 px-6 text-lg min-h-[48px]': size === 'lg',
        },

        // Full width for mobile
        fullWidth && 'w-full',

        // Variant styles
        {
          'bg-primary-500 text-white hover:bg-primary-600 focus:ring-primary-500': variant === 'primary',
          'bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-500': variant === 'secondary',
          'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-primary-500': variant === 'outline',
          'text-gray-700 hover:bg-gray-100 focus:ring-primary-500': variant === 'ghost',
          'bg-red-500 text-white hover:bg-red-600 focus:ring-red-500': variant === 'danger',
        },

        className
      )}
      disabled={disabled || loading}
      {...props}
    >
      {loading && <Spinner className="mr-2" />}
      {children}
    </button>
  );
}
```

#### Input Component with Accessibility
```typescript
// src/components/ui/input.tsx
interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  error?: string;
  label?: string;
  helperText?: string;
  required?: boolean;
}

export function Input({
  className,
  error,
  label,
  helperText,
  required,
  id: providedId,
  ...props
}: InputProps) {
  const inputId = useId();
  const id = providedId || inputId;

  return (
    <div className="space-y-2">
      {label && (
        <Label htmlFor={id} className="text-sm font-medium">
          {label}
          {required && <span className="text-red-500 ml-1">*</span>}
        </Label>
      )}

      <input
        id={id}
        className={cn(
          // Base styles with mobile considerations
          'w-full h-11 px-4', // 44px height for touch
          'text-base', // Prevents zoom on iOS
          'border border-input rounded-md',
          'bg-background text-foreground',
          'placeholder:text-muted-foreground',

          // Focus styles
          'focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',

          // Error state
          error && 'border-destructive focus:ring-destructive',

          // Disabled state
          'disabled:opacity-50 disabled:pointer-events-none',

          className
        )}
        aria-describedby={
          error ? `${id}-error` :
          helperText ? `${id}-help` : undefined
        }
        aria-invalid={!!error}
        {...props}
      />

      {/* Helper text */}
      {helperText && !error && (
        <p id={`${id}-help`} className="text-sm text-muted-foreground">
          {helperText}
        </p>
      )}

      {/* Error message */}
      {error && (
        <p id={`${id}-error`} className="text-sm text-destructive" role="alert">
          {error}
        </p>
      )}
    </div>
  );
}
```

#### MoodScale Component (Accessibility-First)
```typescript
// src/components/ui/mood-scale.tsx
interface MoodScaleProps {
  value?: number;
  onChange?: (value: number) => void;
  disabled?: boolean;
  size?: 'sm' | 'md' | 'lg';
  showLabels?: boolean;
  required?: boolean;
  error?: string;
}

const MOOD_LEVELS = [
  { value: 1, emoji: 'üò¢', label: 'Very Low', description: 'Feeling extremely down or distressed' },
  { value: 2, emoji: 'üòû', label: 'Low', description: 'Feeling quite low or sad' },
  { value: 3, emoji: 'üòê', label: 'Neutral', description: 'Feeling okay, neither good nor bad' },
  { value: 4, emoji: 'üôÇ', label: 'Good', description: 'Feeling pretty good overall' },
  { value: 5, emoji: 'üòä', label: 'Very Good', description: 'Feeling excellent and positive' },
];

export function MoodScale({
  value,
  onChange,
  disabled = false,
  size = 'md',
  showLabels = true,
  required = false,
  error
}: MoodScaleProps) {
  const [selectedValue, setSelectedValue] = useState(value || 0);
  const [focusedIndex, setFocusedIndex] = useState<number>(-1);

  const handleSelect = (newValue: number) => {
    if (disabled) return;
    setSelectedValue(newValue);
    onChange?.(newValue);
  };

  const handleKeyDown = (event: React.KeyboardEvent, index: number) => {
    if (disabled) return;

    switch (event.key) {
      case 'Enter':
      case ' ':
        event.preventDefault();
        handleSelect(MOOD_LEVELS[index].value);
        break;
      case 'ArrowRight':
        event.preventDefault();
        const nextIndex = Math.min(index + 1, MOOD_LEVELS.length - 1);
        setFocusedIndex(nextIndex);
        break;
      case 'ArrowLeft':
        event.preventDefault();
        const prevIndex = Math.max(index - 1, 0);
        setFocusedIndex(prevIndex);
        break;
    }
  };

  const sizeClasses = {
    sm: 'w-12 h-12 text-xl',
    md: 'w-16 h-16 text-2xl',
    lg: 'w-20 h-20 text-3xl'
  };

  return (
    <div className="space-y-4">
      <fieldset className="space-y-4">
        <legend className="text-sm font-medium text-foreground">
          How are you feeling? {required && <span className="text-destructive">*</span>}
        </legend>

        <div className="flex justify-center space-x-2" role="radiogroup">
          {MOOD_LEVELS.map((level, index) => (
            <button
              key={level.value}
              type="button"
              onClick={() => handleSelect(level.value)}
              onKeyDown={(e) => handleKeyDown(e, index)}
              onFocus={() => setFocusedIndex(index)}
              onBlur={() => setFocusedIndex(-1)}
              disabled={disabled}
              className={cn(
                'rounded-full border-2 transition-all duration-200 hover:scale-105',
                'focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
                sizeClasses[size],
                'flex items-center justify-center',
                selectedValue === level.value
                  ? 'border-primary bg-primary/10 shadow-lg'
                  : 'border-border hover:border-primary/50',
                disabled && 'opacity-50 cursor-not-allowed',
                focusedIndex === index && 'ring-2 ring-ring ring-offset-2'
              )}
              aria-label={`Mood level ${level.value}: ${level.label}`}
              aria-describedby={`mood-description-${level.value}`}
              aria-pressed={selectedValue === level.value}
              role="radio"
              aria-checked={selectedValue === level.value}
            >
              <span className={cn(
                selectedValue === level.value ? 'text-primary' : 'text-muted-foreground'
              )}>
                {level.emoji}
              </span>
            </button>
          ))}
        </div>

        {showLabels && (
          <div className="flex justify-between text-xs text-muted-foreground px-1">
            {MOOD_LEVELS.map((level) => (
              <div key={level.value} className="text-center max-w-16">
                <div id={`mood-description-${level.value}`} className="sr-only">
                  {level.description}
                </div>
                <div className="font-medium">{level.label}</div>
              </div>
            ))}
          </div>
        )}

        {selectedValue > 0 && (
          <div className="text-center">
            <p className="text-sm text-muted-foreground">
              Selected: <span className="font-medium text-foreground">
                {MOOD_LEVELS.find(l => l.value === selectedValue)?.label}
              </span>
            </p>
          </div>
        )}

        {error && (
          <p className="text-sm text-destructive text-center" role="alert">
            {error}
          </p>
        )}
      </fieldset>
    </div>
  );
}
```

### Mobile Navigation Component
```typescript
// src/components/navigation/mobile-nav.tsx
interface MobileNavProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
}

export function MobileNav({ isOpen, onClose, children }: MobileNavProps) {
  useEffect(() => {
    if (isOpen) {
      // Prevent body scroll
      document.body.style.overflow = 'hidden';

      // Focus management
      const focusableElements = document.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0] as HTMLElement;

      const handleTabKey = (e: KeyboardEvent) => {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstFocusable) {
              const lastFocusable = focusableElements[focusableElements.length - 1] as HTMLElement;
              lastFocusable.focus();
              e.preventDefault();
            }
          }
        }
      };

      document.addEventListener('keydown', handleTabKey);
      firstFocusable?.focus();

      return () => {
        document.body.style.overflow = 'unset';
        document.removeEventListener('keydown', handleTabKey);
      };
    }
  }, [isOpen]);

  return (
    <>
      {/* Backdrop */}
      <div
        className={cn(
          'fixed inset-0 bg-black/50 z-40 transition-opacity duration-300',
          isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
        )}
        onClick={onClose}
        aria-hidden="true"
      />

      {/* Navigation Panel */}
      <div
        className={cn(
          'fixed top-0 left-0 h-full w-80 max-w-[90vw] bg-background border-r shadow-xl z-50 transform transition-transform duration-300 ease-in-out',
          isOpen ? 'translate-x-0' : '-translate-x-full'
        )}
        role="dialog"
        aria-modal="true"
        aria-label="Mobile navigation"
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-semibold">Menu</h2>
          <Button
            variant="ghost"
            size="icon"
            onClick={onClose}
            aria-label="Close navigation"
          >
            <X className="h-5 w-5" />
          </Button>
        </div>

        {/* Navigation Content */}
        <nav className="flex-1 overflow-y-auto p-4">
          {children}
        </nav>
      </div>
    </>
  );
}
```

## API Integration Specifications

### Mood Tracking API
```typescript
// API Routes
POST /api/mood/entries          // Create mood entry
GET  /api/mood/entries          // List user's mood entries
GET  /api/mood/entries/[id]     // Get specific entry
PUT  /api/mood/entries/[id]     // Update entry
DELETE /api/mood/entries/[id]   // Delete entry

// Request/Response Types
interface MoodEntryRequest {
  moodLevel: 1 | 2 | 3 | 4 | 5;
  factors: string[];
  notes?: string;
  timestamp: string;
  location?: {
    latitude: number;
    longitude: number;
  };
}

interface MoodEntryResponse {
  id: string;
  userId: string;
  moodLevel: number;
  factors: string[];
  notes?: string;
  timestamp: string;
  createdAt: string;
  updatedAt: string;
}
```

### CBT Exercises API
```typescript
// API Routes
GET  /api/cbt/exercises         // List available exercises
GET  /api/cbt/exercises/[id]    // Get exercise details
POST /api/cbt/sessions          // Start exercise session
PUT  /api/cbt/sessions/[id]     // Update session progress
GET  /api/cbt/sessions/[id]     // Get session state

// Session Management
interface ExerciseSession {
  id: string;
  exerciseId: string;
  userId: string;
  progress: number; // 0-100
  currentStep: number;
  responses: Record<string, any>;
  startedAt: string;
  lastActivityAt: string;
  completedAt?: string;
}
```

## Accessibility Implementation

### WCAG 2.1 AA Compliance Strategy

#### 1. Semantic HTML Structure
```typescript
// Proper page structure
export default function Layout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <a href="#main-content" className="sr-only focus:not-sr-only">
          Skip to main content
        </a>
        <header role="banner">
          {/* Header content */}
        </header>
        <main id="main-content" role="main">
          {children}
        </main>
        <footer role="contentinfo">
          {/* Footer content */}
        </footer>
      </body>
    </html>
  );
}
```

#### 2. Focus Management
```typescript
// Modal focus trapping
useEffect(() => {
  if (isOpen) {
    const focusableElements = modalRef.current?.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );

    if (focusableElements) {
      const firstElement = focusableElements[0] as HTMLElement;
      const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;

      const handleTabKey = (e: KeyboardEvent) => {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              lastElement.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastElement) {
              firstElement.focus();
              e.preventDefault();
            }
          }
        }
      };

      document.addEventListener('keydown', handleTabKey);
      firstElement.focus();

      return () => document.removeEventListener('keydown', handleTabKey);
    }
  }
}, [isOpen]);
```

#### 3. ARIA Live Regions
```typescript
// Dynamic content announcements
<div aria-live="polite" aria-atomic="true">
  {error && (
    <p className="text-red-600" role="alert">
      {error}
    </p>
  )}
</div>

<div aria-live="assertive" aria-atomic="true">
  {success && (
    <p className="text-green-600">
      {success}
    </p>
  )}
</div>
```

## Performance Optimization

### Bundle Splitting Strategy
```javascript
// next.config.js
module.exports = {
  experimental: {
    optimizePackageImports: ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu']
  }
}

// Lazy loading for heavy components
const MoodScale = lazy(() => import('../components/ui/mood-scale'));

export function MoodTrackingPage() {
  return (
    <Suspense fallback={<Skeleton />}>
      <MoodScale />
    </Suspense>
  );
}
```

### Image Optimization
```typescript
import Image from 'next/image';

export function OptimizedImage({ src, alt }: { src: string; alt: string }) {
  return (
    <Image
      src={src}
      alt={alt}
      width={400}
      height={300}
      sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
    />
  );
}
```

## Testing Strategy

### Unit Testing
```typescript
// __tests__/components/ui/button.test.tsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Button } from '../button';

describe('Button', () => {
  it('renders with correct text', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByRole('button', { name: /click me/i })).toBeInTheDocument();
  });

  it('handles click events', async () => {
    const handleClick = jest.fn();
    const user = userEvent.setup();

    render(<Button onClick={handleClick}>Click me</Button>);
    await user.click(screen.getByRole('button', { name: /click me/i }));

    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('is accessible via keyboard', async () => {
    const handleClick = jest.fn();
    const user = userEvent.setup();

    render(<Button onClick={handleClick}>Click me</Button>);
    const button = screen.getByRole('button', { name: /click me/i });

    button.focus();
    await user.keyboard('{Enter}');

    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

### Accessibility Testing
```typescript
// __tests__/accessibility/button.a11y.test.tsx
import { render } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { Button } from '../button';

expect.extend(toHaveNoViolations);

describe('Button Accessibility', () => {
  it('has no accessibility violations', async () => {
    const { container } = render(<Button>Accessible Button</Button>);
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

### E2E Testing
```typescript
// e2e/mood-tracking.spec.ts
import { test, expect } from '@playwright/test';

test('complete mood tracking workflow', async ({ page }) => {
  // Navigate to mood tracking
  await page.goto('/mood');

  // Select mood level
  await page.click('[aria-label="Mood level 4: Good"]');

  // Add factors
  await page.click('[data-testid="factor-anxiety"]');
  await page.click('[data-testid="factor-work"]');

  // Add notes
  await page.fill('[name="notes"]', 'Feeling productive today');

  // Submit form
  await page.click('[data-testid="submit-mood"]');

  // Verify success
  await expect(page.locator('[role="alert"]')).toContainText('Mood logged successfully');
});
```

## Deployment Strategy

### Feature Flags
```typescript
// lib/feature-flags.ts
export const FEATURES = {
  MOOD_SCALE_REDESIGN: process.env.NEXT_PUBLIC_MOOD_SCALE_REDESIGN === 'true',
  MOBILE_NAVIGATION: process.env.NEXT_PUBLIC_MOBILE_NAVIGATION === 'true',
  ACCESSIBILITY_ENHANCEMENTS: process.env.NEXT_PUBLIC_ACCESSIBILITY_ENHANCEMENTS === 'true',
} as const;

export function useFeatureFlag(flag: keyof typeof FEATURES): boolean {
  return FEATURES[flag];
}
```

### Progressive Rollout
1. **Phase 1**: Design system deployment (no user impact)
2. **Phase 2**: Component refactoring (feature flags)
3. **Phase 3**: Accessibility enhancements (gradual rollout)
4. **Phase 4**: Mobile optimizations (device-specific)

## Monitoring and Analytics

### Performance Monitoring
```typescript
// lib/performance-monitoring.ts
export function trackComponentRender(componentName: string, duration: number) {
  // Send to analytics service
  analytics.track('component_render', {
    component: componentName,
    duration,
    timestamp: Date.now(),
  });
}

export function trackAccessibilityViolation(violation: any) {
  // Send to error tracking service
  errorTracker.captureException(new Error('Accessibility Violation'), {
    extra: violation,
  });
}
```

### User Experience Metrics
- **Task Completion Rate**: Percentage of successful mood logging
- **Error Rate**: Forms submitted with validation errors
- **Accessibility Score**: axe-core violation count
- **Performance Score**: Lighthouse accessibility and performance scores

This technical design provides a comprehensive blueprint for implementing the mental health platform's UI/UX refactor with strong emphasis on accessibility, performance, and maintainability.